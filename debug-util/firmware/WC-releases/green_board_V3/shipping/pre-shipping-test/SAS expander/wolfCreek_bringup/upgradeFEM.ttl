; ************************************************************************************
; This script was written by "Jabil Shanghai JTS-CS software Team",
; Author: Pollux Su
; Email:  Pollux_Su1@jabil.com
; Date:	  2012.12.07
; All right reserved.
; ************************************************************************************


show -1
timeout = 10 ; connection timeout in seconds
messagebox "Please make sure HotKey is Disabled and Uart port has switch to secondary expander!" "Warning!"
inputbox 'Please input COM Port number :' 'Login'

;connect param2
sprintf2 comport "/C=%s" inputstr
connect comport
if result = 0 then
  sprintf2 msg "Cannot link Tera Term with parameter %s. Click Ok to exit." param2
  messagebox msg "Connection Error"
  closett
  end
elseif result = 1 then
  messagebox "Failed to connect to serial port,Please check the /C paramter. Click Ok to exit." "Connection Error"
  closett
  end
endif
setbaud 115200

;send #30 100   ;ctrl+shift+6 d
send #13 ; carriage return

waitregex "[A|B]1@.*>"  "=>"
if result = 0 then ; Timeout
  sprintf "Script waited %d seconds but did not receive sas FW prompt or boot loader prompt. Please program boot loader to revision 0101 first!... Click Ok to exit." timeout
  messagebox inputstr "Can not access to remote host..."
  closett
  end
endif


getdir rootDir
makepath bin_path rootDir "bin"

timeout=120
sendln "reset"
wait "Hit"
if result = 0 then ; Timeout
  sprintf "Script waited %d seconds but did not receive Hit ^d ... Click Ok to exit." timeout
  messagebox "CAN NOT change to bootloader..." "Bootloader"
  closett
  end
endif
send #4


waitregex  "=>"

sendln 'ver'
wait 'Jabil Boot Loader, Revision 0101'
if result != 1 then
  messagebox  "Primary expander boot Loader FW Revision is not 0101, please update it to revision 0101 first!" "Error" 
  closett
  end
endif

sendln "xmdm"
wait "CC"
if result = 0 then ; Timeout
  sprintf "Script waited %d seconds but did not receive CCCC.... from the host. Click Ok to exit." timeout
  messagebox "Could NOT start sending image bin file" "FW update fail"
  closett
  end
endif
makepath fem_bootloader_bin_path bin_path "wc_trinidad_fem_boot_loader_01_01.bin"
xmodemsend fem_bootloader_bin_path 1
if result = 0 then ; transfer file fail
  messagebox "You Canceled or Couldn't find the image bin file" "FW update fail"
  closett
  end
endif

timeout=120
sendln "reset"
wait "Hit"
if result = 0 then ; Timeout
  sprintf "Script waited %d seconds but did not receive Hit ^d ... Click Ok to exit." timeout
  messagebox "CAN NOT change to bootloader..." "Bootloader"
  closett
  end
endif
send #4

waitregex  "=>"

sendln "xmdm"
wait "CC"
if result = 0 then ; Timeout
  sprintf "Script waited %d seconds but did not receive CCCC.... from the host. Click Ok to exit." timeout
  messagebox "Could NOT start sending image bin file" "FW update fail"
  closett
  end
endif
makepath fem_sas_bin_path bin_path "wc_trinidad_fem_sas_update_01_01.bin"
xmodemsend fem_sas_bin_path 1
if result = 0 then ; transfer file fail
  messagebox "You Canceled or Couldn't find the image bin file" "FW update fail"
  closett
  end
endif



timeout = 120
waitregex  "=>"
sendln "boot"

waitregex  "[A|B]1@.*>"
messagebox "SAS FW update finished!" "FW update"
disconnect
closett
end
; End of generated script
